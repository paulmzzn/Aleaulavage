document.addEventListener("DOMContentLoaded",function(){var defaultPrice=null;var priceHeader=document.querySelector(".purchase-header .price");if(priceHeader){defaultPrice=priceHeader.innerHTML}document.querySelectorAll(".variations_form").forEach(function(form){form.querySelectorAll("select").forEach(function(select){const label=select.closest("tr").querySelector("label");if(!label)return;const attrName=label.textContent.trim().toLowerCase();if(attrName==="couleur"||attrName==="couleurs"||attrName==="color"||attrName==="colors"){select.style.display="none";const swatchContainer=document.createElement("div");swatchContainer.className="color-swatches";Array.from(select.options).forEach(function(option){if(!option.value)return;const swatch=document.createElement("button");swatch.type="button";swatch.className="color-swatch";swatch.title=option.text;swatch.setAttribute("data-value",option.value);const colorKey=option.text.trim().toLowerCase();swatch.style.background=COLOR_MAP[colorKey]||option.value;if(option.selected)swatch.classList.add("selected");swatch.addEventListener("click",function(){select.value=option.value;select.dispatchEvent(new Event("change",{bubbles:true}));swatchContainer.querySelectorAll(".color-swatch").forEach(btn=>btn.classList.remove("selected"));swatch.classList.add("selected");updateColorBadge(swatch.style.background,swatch.title);showClearButton(form)});swatchContainer.appendChild(swatch)});const br=document.createElement("br");label.parentNode.insertBefore(br,label.nextSibling);label.parentNode.insertBefore(swatchContainer,br.nextSibling)}else{createAttributeButtons(select,label,attrName,form)}})});setupSwatchBadgeSync();document.querySelectorAll(".variations_form").forEach(function(form){setupGlobalClearButton(form)});setupWishlistButton()});function updateColorBadge(color,label){const badge=document.getElementById("selected-color-badge");if(!badge)return;const dot=badge.querySelector(".color-dot");if(color){dot.style.background=color;dot.title=label||"";badge.style.display="flex"}else{badge.style.display="none"}}function setupSwatchBadgeSync(){document.querySelectorAll(".color-swatches").forEach(function(container){container.querySelectorAll(".color-swatch").forEach(function(swatch){swatch.addEventListener("click",function(){updateColorBadge(swatch.style.background,swatch.title)});if(swatch.classList.contains("selected")){updateColorBadge(swatch.style.background,swatch.title)}})})}function createAttributeButtons(select,label,attrName,form){select.style.display="none";const buttonContainer=document.createElement("div");buttonContainer.className="attribute-buttons";buttonContainer.setAttribute("data-attribute",attrName);buttonContainer.style.cssText=`\n    display: flex !important;\n    flex-wrap: wrap !important;\n    gap: 8px !important;\n    margin: 12px 0 18px 0 !important;\n    max-width: 100% !important;\n    overflow: hidden !important;\n  `;Array.from(select.options).forEach(function(option){if(!option.value)return;const button=document.createElement("button");button.type="button";button.className="attribute-button";button.textContent=option.text;button.setAttribute("data-value",option.value);button.title=option.text;button.style.cssText=`\n      padding: 12px 20px !important;\n      border: 2px solid #e3e5e8 !important;\n      border-radius: 8px !important;\n      background: linear-gradient(135deg, #fff 0%, #fafbfc 100%) !important;\n      color: #0E2141 !important;\n      font-size: 15px !important;\n      font-weight: 600 !important;\n      cursor: pointer !important;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;\n      outline: none !important;\n      min-height: 44px !important;\n      min-width: 60px !important;\n      display: flex !important;\n      align-items: center !important;\n      justify-content: center !important;\n      position: relative !important;\n      box-shadow: 0 2px 6px rgba(0,0,0,0.08) !important;\n      text-transform: capitalize !important;\n      letter-spacing: 0.3px !important;\n      text-decoration: none !important;\n      margin: 0 !important;\n      font-family: inherit !important;\n    `;if(option.selected)button.classList.add("selected");button.addEventListener("mouseenter",function(){if(!this.classList.contains("selected")){this.style.borderColor="#f1bb69";this.style.background="linear-gradient(135deg, #fdf8f1 0%, #fcf4e8 100%)";this.style.transform="translateY(-1px)";this.style.boxShadow="0 4px 12px rgba(241, 187, 105, 0.25)"}});button.addEventListener("mouseleave",function(){if(!this.classList.contains("selected")){this.style.borderColor="#e3e5e8";this.style.background="linear-gradient(135deg, #fff 0%, #fafbfc 100%)";this.style.transform="translateY(0)";this.style.boxShadow="0 2px 6px rgba(0,0,0,0.08)"}});button.addEventListener("click",function(){if(button.hasAttribute("data-disabled"))return;select.value=option.value;select.dispatchEvent(new Event("change",{bubbles:true}));buttonContainer.querySelectorAll(".attribute-button").forEach(btn=>{btn.classList.remove("selected");btn.style.borderColor="#e3e5e8";btn.style.background="linear-gradient(135deg, #fff 0%, #fafbfc 100%)";btn.style.transform="translateY(0)";btn.style.boxShadow="0 2px 6px rgba(0,0,0,0.08)";btn.style.fontWeight="600"});button.classList.add("selected");button.style.borderColor="#f1bb69";button.style.background="linear-gradient(135deg, #f1bb69 0%, #e29a3d 100%)";button.style.transform="translateY(-1px)";button.style.boxShadow="0 6px 16px rgba(241, 187, 105, 0.35)";button.style.fontWeight="700";setTimeout(()=>updateAttributeAvailability(form),100);showClearButton(form)});buttonContainer.appendChild(button)});const br=document.createElement("br");label.parentNode.insertBefore(br,label.nextSibling);label.parentNode.insertBefore(buttonContainer,br.nextSibling)}function updateAttributeAvailability(form){console.log("=== UPDATING ATTRIBUTE AVAILABILITY ===");const variationData=form.getAttribute("data-product_variations");if(!variationData){console.log("‚ùå No variation data found");return}let variations=[];try{variations=JSON.parse(variationData);console.log("‚úÖ Found",variations.length,"variations")}catch(e){console.log("‚ùå Failed to parse variation data");return}const formData=new FormData(form);console.log("üìã Current form selections:");for(let[key,value]of formData.entries()){if(key.startsWith("attribute_")&&value){console.log(`  ${key}: ${value}`)}}const selects=form.querySelectorAll('select[name^="attribute_"]');selects.forEach(function(select){const attrName=select.name;if(attrName==="attribute_couleur"){const colorSwatches=form.querySelectorAll(".color-swatch");console.log(`üé® Processing ${colorSwatches.length} color swatches`);colorSwatches.forEach(function(swatch){const colorValue=swatch.getAttribute("data-value");const isAvailable=checkAvailability(variations,formData,attrName,colorValue);console.log(`üé® ${colorValue}: ${isAvailable?"‚úÖ":"‚ùå"}`);if(!isAvailable){swatch.style.opacity="0.4";swatch.style.cursor="not-allowed";swatch.style.filter="grayscale(70%)";swatch.setAttribute("data-disabled","true")}else{swatch.style.opacity="1";swatch.style.cursor="pointer";swatch.style.filter="none";swatch.removeAttribute("data-disabled")}})}else{const buttonContainer=select.parentNode.querySelector(".attribute-buttons");if(buttonContainer){const buttons=buttonContainer.querySelectorAll(".attribute-button");console.log(`üîò Processing ${buttons.length} buttons for ${attrName}`);buttons.forEach(function(button){const buttonValue=button.getAttribute("data-value");const isAvailable=checkAvailability(variations,formData,attrName,buttonValue);console.log(`üîò ${buttonValue}: ${isAvailable?"‚úÖ":"‚ùå"}`);if(!isAvailable){button.style.opacity="0.4";button.style.cursor="not-allowed";button.style.background="#f0f0f0";button.style.borderColor="#ccc";button.style.color="#888";button.setAttribute("data-disabled","true")}else{button.style.opacity="1";button.style.cursor="pointer";button.style.background="linear-gradient(135deg, #fff 0%, #fafbfc 100%)";button.style.borderColor="#e3e5e8";button.style.color="#0E2141";button.removeAttribute("data-disabled")}})}}})}function checkAvailability(variations,currentFormData,testAttrName,testValue){return variations.some(function(variation){if(!variation.variation_is_active||!variation.is_in_stock){return false}const testCombination={};for(let[key,value]of currentFormData.entries()){if(key.startsWith("attribute_")&&value){testCombination[key]=value}}testCombination[testAttrName]=testValue;return Object.keys(testCombination).every(function(attrKey){const varValue=variation.attributes[attrKey];const testVal=testCombination[attrKey];return!varValue||varValue===testVal})})}document.addEventListener("DOMContentLoaded",function(){console.log("üöÄ Initializing availability checker");setTimeout(function(){const forms=document.querySelectorAll(".variations_form");console.log("üìù Found",forms.length,"variation forms");forms.forEach(function(form){updateAttributeAvailability(form);form.addEventListener("change",function(){console.log("üîÑ Form changed, updating availability");setTimeout(()=>updateAttributeAvailability(form),100)})})},1500)});function setupGlobalClearButton(form){let clearBtn=form.querySelector(".reset_variations");if(!clearBtn||clearBtn.hasAttribute("data-restyled"))return;clearBtn.setAttribute("data-restyled","true");clearBtn.innerHTML='<i class="fa fa-times-circle"></i> Effacer toutes les s√©lections';clearBtn.style.cssText=`\n    background: #f8f9fa !important;\n    color: #6c757d !important;\n    border: 1px solid #dee2e6 !important;\n    border-radius: 6px !important;\n    padding: 8px 16px !important;\n    font-size: 14px !important;\n    font-weight: 500 !important;\n    cursor: pointer !important;\n    transition: all 0.2s !important;\n    text-decoration: underline !important;\n    display: none !important;\n    align-items: center !important;\n    gap: 6px !important;\n    margin: 0 !important;\n    width: auto !important;\n  `;clearBtn.addEventListener("mouseenter",function(){this.style.background="#e9ecef";this.style.color="#495057";this.style.borderColor="#adb5bd"});clearBtn.addEventListener("mouseleave",function(){this.style.background="#f8f9fa";this.style.color="#6c757d";this.style.borderColor="#dee2e6"});const variationsTable=form.querySelector("table.variations");if(variationsTable){const container=document.createElement("div");container.className="clear-button-container";container.style.cssText="text-align: center; margin: 0; height: 0; overflow: hidden; transition: all 0.2s;";container.appendChild(clearBtn);variationsTable.insertAdjacentElement("afterend",container);form.clearButtonContainer=container}clearBtn.addEventListener("click",function(e){e.preventDefault();form.querySelectorAll(".color-swatch").forEach(swatch=>{swatch.classList.remove("selected")});form.querySelectorAll(".attribute-button").forEach(btn=>{btn.classList.remove("selected");btn.removeAttribute("data-disabled");btn.style.opacity="1";btn.style.cursor="pointer";btn.style.background="linear-gradient(135deg, #fff 0%, #fafbfc 100%)";btn.style.borderColor="#e3e5e8";btn.style.color="#0E2141";btn.style.boxShadow="0 2px 6px rgba(0,0,0,0.08)"});form.querySelectorAll('select[name^="attribute_"]').forEach(select=>{select.value="";select.dispatchEvent(new Event("change",{bubbles:true}))});const badge=document.getElementById("selected-color-badge");if(badge)badge.style.display="none";setTimeout(function(){const priceHeader=document.querySelector(".purchase-header .price");if(priceHeader&&defaultPrice){priceHeader.innerHTML=defaultPrice}const singleVar=document.querySelector(".single_variation");if(singleVar){singleVar.style.display="none";singleVar.innerHTML=""}},50);hideClearButton(form)})}function showClearButton(form){if(form.clearButtonContainer){const container=form.clearButtonContainer;const button=container.querySelector(".reset_variations");container.style.height="auto";container.style.margin="5px 0 0 0";container.style.overflow="visible";button.style.display="inline-flex"}}function hideClearButton(form){if(form.clearButtonContainer){const container=form.clearButtonContainer;const button=container.querySelector(".reset_variations");container.style.height="0";container.style.margin="0";container.style.overflow="hidden";button.style.display="none"}}function setupWishlistButton(){document.querySelectorAll(".wishlist-btn").forEach(function(wishlistBtn){const heartIcon=wishlistBtn.querySelector("i");if(!heartIcon)return;const productId=wishlistBtn.getAttribute("data-product-id");if(!productId)return;if(typeof wishlist_ajax==="undefined"){console.log("Wishlist AJAX not available");return}if(!heartIcon.classList.contains("fa-heart")){heartIcon.classList.add("fa-heart")}wishlistBtn.addEventListener("click",function(e){e.preventDefault();if(!wishlist_ajax.is_logged_in){showLoginModal();return}const isActive=this.classList.contains("active");const action=isActive?"remove_from_wishlist":"add_to_wishlist";const formData=new FormData;formData.append("action",action);formData.append("product_id",productId);formData.append("nonce",wishlist_ajax.nonce);wishlistBtn.style.pointerEvents="none";wishlistBtn.style.opacity="0.7";fetch(wishlist_ajax.ajax_url,{method:"POST",body:formData}).then(response=>response.json()).then(data=>{console.log("R√©ponse AJAX wishlist:",data);if(data.success){if(data.data&&data.data.action==="added"){this.classList.add("active");heartIcon.classList.remove("fa-regular");heartIcon.classList.add("fa-solid");console.log("Produit ajout√© aux favoris")}else if(data.data&&data.data.action==="removed"){this.classList.remove("active");heartIcon.classList.remove("fa-solid");heartIcon.classList.add("fa-regular");console.log("Produit retir√© des favoris")}if(data.data&&data.data.message){console.log(data.data.message)}}else{const errorMessage=data.data&&data.data.message?data.data.message:"Erreur inconnue";console.error("Erreur wishlist:",errorMessage);alert(errorMessage)}}).catch(error=>{console.error("Erreur AJAX:",error);alert("Erreur de connexion. Veuillez r√©essayer.")}).finally(()=>{wishlistBtn.style.pointerEvents="auto";wishlistBtn.style.opacity="1"})})})}function showLoginModal(){let existingModal=document.getElementById("login-modal");if(existingModal){existingModal.style.display="flex";return}const modal=document.createElement("div");modal.id="login-modal";modal.style.cssText=`\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.6);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 9999;\n    backdrop-filter: blur(3px);\n  `;const modalContent=document.createElement("div");modalContent.style.cssText=`\n    background: #fff;\n    padding: 32px 28px;\n    border-radius: 12px;\n    max-width: 420px;\n    width: 90%;\n    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);\n    position: relative;\n    text-align: center;\n    animation: modalSlideIn 0.3s ease-out;\n  `;const style=document.createElement("style");style.textContent=`\n    @keyframes modalSlideIn {\n      from {\n        opacity: 0;\n        transform: translateY(-30px) scale(0.95);\n      }\n      to {\n        opacity: 1;\n        transform: translateY(0) scale(1);\n      }\n    }\n  `;document.head.appendChild(style);modalContent.innerHTML=`\n    <button id="close-modal" style="\n      position: absolute;\n      top: 12px;\n      right: 16px;\n      background: none;\n      border: none;\n      font-size: 24px;\n      color: #999;\n      cursor: pointer;\n      padding: 4px;\n      line-height: 1;\n      transition: color 0.2s;\n    " onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">&times;</button>\n    \n    <div style="margin-bottom: 24px;">\n      <i class="fa-solid fa-heart" style="\n        font-size: 48px;\n        color: #f1bb69;\n        margin-bottom: 16px;\n        display: block;\n      "></i>\n      <h3 style="\n        color: #0E2141;\n        font-size: 24px;\n        font-weight: 700;\n        margin-bottom: 12px;\n        line-height: 1.2;\n      ">Connexion</h3>\n      <p style="\n        color: #666;\n        font-size: 16px;\n        line-height: 1.5;\n        margin-bottom: 24px;\n      ">Connectez-vous pour ajouter ce produit √† vos favoris.</p>\n    </div>\n    \n    <form id="login-form" style="text-align: left;">\n      <div style="margin-bottom: 16px;">\n        <label style="\n          display: block;\n          color: #0E2141;\n          font-weight: 600;\n          margin-bottom: 6px;\n          font-size: 14px;\n        ">Email ou nom d'utilisateur</label>\n        <input type="text" id="login-username" required style="\n          width: 100%;\n          padding: 12px 16px;\n          border: 2px solid #e3e5e8;\n          border-radius: 8px;\n          font-size: 16px;\n          box-sizing: border-box;\n          transition: border-color 0.2s;\n        " onfocus="this.style.borderColor='#f1bb69'" onblur="this.style.borderColor='#e3e5e8'">\n      </div>\n      \n      <div style="margin-bottom: 20px;">\n        <label style="\n          display: block;\n          color: #0E2141;\n          font-weight: 600;\n          margin-bottom: 6px;\n          font-size: 14px;\n        ">Mot de passe</label>\n        <input type="password" id="login-password" required style="\n          width: 100%;\n          padding: 12px 16px;\n          border: 2px solid #e3e5e8;\n          border-radius: 8px;\n          font-size: 16px;\n          box-sizing: border-box;\n          transition: border-color 0.2s;\n        " onfocus="this.style.borderColor='#f1bb69'" onblur="this.style.borderColor='#e3e5e8'">\n      </div>\n      \n      <div id="login-error" style="\n        display: none;\n        background: #ffe6e6;\n        color: #d63031;\n        padding: 12px;\n        border-radius: 6px;\n        margin-bottom: 16px;\n        font-size: 14px;\n        border: 1px solid #fab1a0;\n      "></div>\n      \n      <div style="display: flex; gap: 12px; justify-content: center;">\n        <button type="submit" id="submit-login" style="\n          background: #f1bb69;\n          color: #0E2141;\n          border: none;\n          padding: 14px 24px;\n          border-radius: 8px;\n          font-size: 16px;\n          font-weight: 600;\n          cursor: pointer;\n          transition: all 0.2s;\n          min-width: 140px;\n        " onmouseover="this.style.background='#e29a3d'" onmouseout="this.style.background='#f1bb69'">\n          Se connecter\n        </button>\n        \n        <button type="button" id="cancel-login" style="\n          background: #f8f9fa;\n          color: #6c757d;\n          border: 1px solid #dee2e6;\n          padding: 14px 24px;\n          border-radius: 8px;\n          font-size: 16px;\n          font-weight: 500;\n          cursor: pointer;\n          transition: all 0.2s;\n          min-width: 120px;\n        " onmouseover="this.style.background='#e9ecef'; this.style.color='#495057'" onmouseout="this.style.background='#f8f9fa'; this.style.color='#6c757d'">\n          Annuler\n        </button>\n      </div>\n    </form>\n  `;modal.appendChild(modalContent);document.body.appendChild(modal);function closeModal(){modal.style.display="none"}document.getElementById("close-modal").addEventListener("click",closeModal);modal.addEventListener("click",function(e){if(e.target===modal){closeModal()}});document.getElementById("cancel-login").addEventListener("click",closeModal);document.getElementById("login-form").addEventListener("submit",function(e){e.preventDefault();const username=document.getElementById("login-username").value;const password=document.getElementById("login-password").value;const submitBtn=document.getElementById("submit-login");const errorDiv=document.getElementById("login-error");if(!username||!password){showLoginError("Veuillez remplir tous les champs.");return}submitBtn.disabled=true;submitBtn.textContent="Connexion...";submitBtn.style.opacity="0.7";errorDiv.style.display="none";const formData=new FormData;formData.append("action","ajax_login");formData.append("username",username);formData.append("password",password);formData.append("security",wishlist_ajax.nonce);fetch(wishlist_ajax.ajax_url,{method:"POST",body:formData}).then(response=>response.json()).then(data=>{if(data.success){submitBtn.textContent="Connect√© !";submitBtn.style.background="#27ae60";setTimeout(()=>{window.location.reload()},1e3)}else{showLoginError(data.data?data.data.message:"Identifiants incorrects.");resetLoginButton()}}).catch(error=>{console.error("Erreur AJAX:",error);showLoginError("Erreur de connexion. Veuillez r√©essayer.");resetLoginButton()});function showLoginError(message){errorDiv.textContent=message;errorDiv.style.display="block"}function resetLoginButton(){submitBtn.disabled=false;submitBtn.textContent="Se connecter";submitBtn.style.opacity="1";submitBtn.style.background="#f1bb69"}});document.addEventListener("keydown",function(e){if(e.key==="Escape"&&modal.style.display==="flex"){closeModal()}})}const COLOR_MAP={rouge:"#e74c3c",jaune:"#f1c40f",bleu:"#2980d9","bleu clair":"#5dade2",vert:"#27ae60",orange:"#f39c12",noir:"#222",noire:"#222",blanc:"#fff",gris:"#bdc3c7",violet:"#8e44ad",rose:"#fd79a8",marron:"#8d5524",beige:"#f5e6ca",transparent:"transparent"};